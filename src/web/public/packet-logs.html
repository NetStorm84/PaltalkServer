<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packet Logs - Paltalk Server</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #0f172a;
            color: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #1e293b;
            border-bottom: 2px solid #334155;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            color: #3b82f6;
            font-size: 1.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }

        .nav-links {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .nav-link {
            background: #334155;
            color: #e2e8f0;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid #475569;
        }

        .nav-link:hover {
            background: #475569;
            color: #f8fafc;
            transform: translateY(-1px);
        }

        .nav-link.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls-bar {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 10px 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            height: 50px;
            flex-shrink: 0;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            color: #cbd5e1;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .control-group select,
        .control-group input {
            background: #334155;
            border: 1px solid #475569;
            color: #f8fafc;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 18px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #64748b;
            transition: 0.3s;
            border-radius: 18px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3b82f6;
        }

        input:checked + .slider:before {
            transform: translateX(16px);
        }

        .logs-container {
            height: calc(100vh - 110px);
            overflow-y: auto;
            padding: 0;
            background: #0f172a;
        }

        .logs-container::-webkit-scrollbar {
            width: 8px;
        }

        .logs-container::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .logs-container::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .logs-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .packet-entry {
            border-bottom: 1px solid #1e293b;
            margin: 0;
            transition: background-color 0.2s ease;
        }

        .packet-entry:hover {
            background: #1e293b;
        }

        .packet-header {
            padding: 8px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .packet-direction {
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            min-width: 90px;
            text-align: center;
        }

        .direction-client-server {
            background: #1e40af;
            color: #dbeafe;
        }

        .direction-server-client {
            background: #059669;
            color: #d1fae5;
        }

        .packet-sequence {
            color: #64748b;
            font-weight: 600;
            min-width: 60px;
        }

        .packet-type {
            color: #f59e0b;
            font-weight: 600;
            min-width: 100px;
        }

        .packet-timestamp {
            color: #94a3b8;
            font-size: 0.75rem;
            min-width: 80px;
        }

        .packet-size {
            color: #8b5cf6;
            font-weight: 500;
            min-width: 60px;
        }

        .packet-summary {
            color: #cbd5e1;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .packet-toggle {
            color: #64748b;
            font-size: 0.7rem;
            padding: 2px 4px;
            transition: color 0.2s ease;
        }

        .packet-entry.expanded .packet-toggle {
            color: #3b82f6;
        }

        .packet-details {
            display: none;
            background: #1e293b;
            border-top: 1px solid #334155;
            padding: 15px 20px;
        }

        .packet-entry.expanded .packet-details {
            display: block;
        }

        .packet-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .detail-section {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 10px;
        }

        .detail-section h4 {
            color: #3b82f6;
            font-size: 0.8rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .detail-field {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 0.75rem;
        }

        .detail-field .label {
            color: #94a3b8;
        }

        .detail-field .value {
            color: #f8fafc;
            font-weight: 500;
        }

        .payload-section {
            grid-column: 1 / -1;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 10px;
        }

        .payload-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .payload-tab {
            background: #334155;
            color: #cbd5e1;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .payload-tab.active {
            background: #3b82f6;
            color: white;
        }

        .payload-content {
            background: #000;
            border: 1px solid #374151;
            border-radius: 3px;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
            line-height: 1.3;
        }

        .hex-data { color: #fbbf24; }
        .ascii-data { color: #34d399; }
        .binary-data { color: #a78bfa; }
        .decimal-data { color: #fb7185; }

        .no-logs {
            text-align: center;
            color: #64748b;
            padding: 40px 20px;
            font-size: 0.9rem;
        }

        .filter-stats {
            color: #64748b;
            font-size: 0.75rem;
            padding: 8px 20px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }

        .back-link {
            color: #3b82f6;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }

        .back-link:hover {
            color: #2563eb;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                height: auto;
                padding: 10px;
                gap: 10px;
            }

            .controls-bar {
                flex-direction: column;
                height: auto;
                align-items: flex-start;
                gap: 10px;
            }

            .logs-container {
                height: calc(100vh - 140px);
            }

            .packet-details-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <div class="logo">P</div>
            Packet Logs
        </h1>
        <div class="nav-links">
            <a href="/" class="nav-link">üìä Dashboard</a>
            <a href="/voice-dashboard.html" class="nav-link">üéôÔ∏è Voice</a>
            <a href="/packet-logs.html" class="nav-link active">üì¶ Packets</a>
            <a href="/bot-management.html" class="nav-link">ü§ñ Bots</a>
        </div>
        <div class="connection-status">
            <div class="status-dot" id="connectionDot"></div>
            <span id="connectionStatus">Connected</span>
        </div>
    </div>

    <div class="controls-bar">
        <div class="control-group">
            <label>Auto-refresh:</label>
            <label class="switch">
                <input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="control-group">
            <label>Direction:</label>
            <select id="directionFilter" onchange="applyFilters()">
                <option value="all">All</option>
                <option value="client-server">Client ‚Üí Server</option>
                <option value="server-client">Server ‚Üí Client</option>
            </select>
        </div>

        <div class="control-group">
            <label>Packet Type:</label>
            <select id="typeFilter" onchange="applyFilters()">
                <option value="all">All Types</option>
            </select>
        </div>

        <div class="control-group">
            <label>Show Details:</label>
            <label class="switch">
                <input type="checkbox" id="showDetails" onchange="toggleDetailsView()">
                <span class="slider"></span>
            </label>
        </div>

        <div class="control-group">
            <label>Max Entries:</label>
            <input type="number" id="maxEntries" value="1000" min="100" max="10000" step="100" onchange="applyFilters()">
        </div>

        <div class="control-group">
            <button class="btn" onclick="refreshLogs()">üîÑ Refresh</button>
            <button class="btn btn-secondary" onclick="exportLogs()">üì• Export</button>
            <button class="btn btn-danger" onclick="clearLogs()">üóëÔ∏è Clear</button>
        </div>
    </div>

    <div class="filter-stats" id="filterStats">
        Loading packet logs...
    </div>

    <div class="logs-container" id="logsContainer">
        <div class="no-logs">
            <p>Loading packet logs...</p>
        </div>
    </div>

    <script>
        // WebSocket connection
        const socket = io();
        let packetLogs = [];
        let filteredLogs = [];
        let autoRefreshInterval = null;
        let isConnected = false;
        let expandedPackets = new Set(); // Track which packets are expanded

        // Connection handling
        socket.on('connect', () => {
            isConnected = true;
            updateConnectionStatus(true);
            loadPacketLogs();
        });

        socket.on('disconnect', () => {
            isConnected = false;
            updateConnectionStatus(false);
        });

        // Real-time packet updates
        socket.on('packetLogged', (packetData) => {
            addPacketToLogs(packetData);
        });

        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            const dotEl = document.getElementById('connectionDot');
            
            if (connected) {
                statusEl.textContent = 'Connected';
                dotEl.style.background = '#10b981';
            } else {
                statusEl.textContent = 'Disconnected';
                dotEl.style.background = '#ef4444';
            }
        }

        async function loadPacketLogs() {
            try {
                const response = await fetch('/api/logs/packets');
                if (response.ok) {
                    const data = await response.json();
                    packetLogs = data.logs || [];
                    populateTypeFilter();
                    applyFilters();
                } else {
                    throw new Error('Failed to load packet logs');
                }
            } catch (error) {
                console.error('Failed to load packet logs:', error);
                document.getElementById('logsContainer').innerHTML = 
                    '<div class="no-logs"><p>Failed to load packet logs</p></div>';
            }
        }

        function addPacketToLogs(packetData) {
            packetLogs.unshift(packetData);
            
            // Limit total logs to prevent memory issues
            const maxLogs = parseInt(document.getElementById('maxEntries').value) * 2;
            if (packetLogs.length > maxLogs) {
                packetLogs = packetLogs.slice(0, maxLogs);
            }
            
            populateTypeFilter();
            
            // Instead of re-rendering everything, just add the new packet if it matches filters
            const directionFilter = document.getElementById('directionFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            // Check if new packet matches current filters
            let shouldShow = true;
            if (directionFilter !== 'all') {
                if (directionFilter === 'client-server' && packetData.direction !== 'CLIENT‚ÜíSERVER') shouldShow = false;
                if (directionFilter === 'server-client' && packetData.direction !== 'SERVER‚ÜíCLIENT') shouldShow = false;
            }
            if (typeFilter !== 'all' && packetData.type !== typeFilter) shouldShow = false;
            
            if (shouldShow && filteredLogs.length < parseInt(document.getElementById('maxEntries').value)) {
                // Add to filtered logs and prepend to UI
                filteredLogs.unshift(packetData);
                
                const container = document.getElementById('logsContainer');
                if (container.querySelector('.no-logs')) {
                    // If showing "no logs" message, replace with actual content
                    applyFilters();
                } else {
                    // Prepend new packet entry
                    const newPacketHtml = createPacketLogEntry(packetData, 0);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = newPacketHtml;
                    const newPacketElement = tempDiv.firstChild;
                    
                    // Update indices of existing packets
                    const existingPackets = container.querySelectorAll('.packet-entry');
                    existingPackets.forEach((packet, index) => {
                        const oldIndex = index;
                        const newIndex = index + 1;
                        packet.id = `packet-${newIndex}`;
                        
                        // Update onclick handler
                        const header = packet.querySelector('.packet-header');
                        if (header) {
                            header.setAttribute('onclick', `togglePacketDetails(${newIndex})`);
                        }
                        
                        // Update expanded state tracking
                        if (expandedPackets.has(oldIndex)) {
                            expandedPackets.delete(oldIndex);
                            expandedPackets.add(newIndex);
                        }
                    });
                    
                    container.insertBefore(newPacketElement, container.firstChild);
                    
                    // Limit displayed entries
                    const maxEntries = parseInt(document.getElementById('maxEntries').value);
                    const allEntries = container.querySelectorAll('.packet-entry');
                    if (allEntries.length > maxEntries) {
                        for (let i = maxEntries; i < allEntries.length; i++) {
                            allEntries[i].remove();
                        }
                        filteredLogs = filteredLogs.slice(0, maxEntries);
                    }
                }
                
                updateFilterStats();
            }
        }

        function populateTypeFilter() {
            const typeFilter = document.getElementById('typeFilter');
            const currentValue = typeFilter.value;
            
            // Get unique packet types
            const types = [...new Set(packetLogs.map(log => log.type || 'Unknown'))].sort();
            
            // Clear and repopulate
            typeFilter.innerHTML = '<option value="all">All Types</option>';
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });
            
            // Restore previous selection
            typeFilter.value = currentValue;
        }

        function applyFilters() {
            const directionFilter = document.getElementById('directionFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const maxEntries = parseInt(document.getElementById('maxEntries').value);

            filteredLogs = packetLogs.filter(log => {
                // Direction filter
                if (directionFilter !== 'all') {
                    if (directionFilter === 'client-server' && log.direction !== 'CLIENT‚ÜíSERVER') return false;
                    if (directionFilter === 'server-client' && log.direction !== 'SERVER‚ÜíCLIENT') return false;
                }

                // Type filter
                if (typeFilter !== 'all' && log.type !== typeFilter) return false;

                return true;
            }).slice(0, maxEntries);

            renderLogs();
            updateFilterStats();
        }

        function renderLogs() {
            const container = document.getElementById('logsContainer');
            
            if (filteredLogs.length === 0) {
                container.innerHTML = '<div class="no-logs"><p>No packet logs match current filters</p></div>';
                return;
            }

            const logsHtml = filteredLogs.map((log, index) => createPacketLogEntry(log, index)).join('');
            container.innerHTML = logsHtml;
            
            // Restore expanded state
            expandedPackets.forEach(index => {
                const packetEntry = document.getElementById(`packet-${index}`);
                if (packetEntry) {
                    packetEntry.classList.add('expanded');
                    const toggle = packetEntry.querySelector('.packet-toggle');
                    if (toggle) toggle.textContent = '‚ñ≤';
                }
            });
        }

        function createPacketLogEntry(log, index) {
            const directionClass = log.direction === 'CLIENT‚ÜíSERVER' ? 'direction-client-server' : 'direction-server-client';
            const timestamp = new Date(log.timestamp).toLocaleTimeString();
            
            return `
                <div class="packet-entry" id="packet-${index}">
                    <div class="packet-header" onclick="togglePacketDetails(${index})">
                        <span class="packet-direction ${directionClass}">${log.direction}</span>
                        <span class="packet-sequence">#${log.sequence}</span>
                        <span class="packet-type">${log.type || 'Unknown'}</span>
                        <span class="packet-timestamp">${timestamp}</span>
                        <span class="packet-size">${log.size}B</span>
                        <span class="packet-summary">${log.summary || 'No summary available'}</span>
                        <span class="packet-toggle">‚ñº</span>
                    </div>
                    <div class="packet-details">
                        ${createPacketDetailsHTML(log)}
                    </div>
                </div>
            `;
        }

        function createPacketDetailsHTML(log) {
            const details = log.details || {};
            const header = details.header || {};
            const payload = details.payload || {};

            return `
                <div class="packet-details-grid">
                    <div class="detail-section">
                        <h4>Header Information</h4>
                        <div class="detail-field">
                            <span class="label">Length:</span>
                            <span class="value">${header.length || 'N/A'}</span>
                        </div>
                        <div class="detail-field">
                            <span class="label">Type:</span>
                            <span class="value">${header.type || 'N/A'}</span>
                        </div>
                        <div class="detail-field">
                            <span class="label">Raw Bytes:</span>
                            <span class="value">${header.rawBytes || 'N/A'}</span>
                        </div>
                        ${header.extended ? Object.entries(header.extended).map(([key, value]) => 
                            `<div class="detail-field">
                                <span class="label">${key}:</span>
                                <span class="value">${value}</span>
                            </div>`
                        ).join('') : ''}
                    </div>
                    
                    <div class="detail-section">
                        <h4>Packet Metadata</h4>
                        <div class="detail-field">
                            <span class="label">Timestamp:</span>
                            <span class="value">${new Date(log.timestamp).toISOString()}</span>
                        </div>
                        <div class="detail-field">
                            <span class="label">Sequence:</span>
                            <span class="value">${log.sequence}</span>
                        </div>
                        <div class="detail-field">
                            <span class="label">Size:</span>
                            <span class="value">${log.size} bytes</span>
                        </div>
                        <div class="detail-field">
                            <span class="label">Direction:</span>
                            <span class="value">${log.direction}</span>
                        </div>
                    </div>
                    
                    ${payload.hex || payload.ascii || payload.binary || payload.decimal ? `
                    <div class="payload-section">
                        <h4>Payload Data</h4>
                        <div class="payload-tabs">
                            ${payload.hex ? '<button class="payload-tab active" onclick="showPayloadTab(event, \'hex\')">HEX</button>' : ''}
                            ${payload.ascii ? '<button class="payload-tab" onclick="showPayloadTab(event, \'ascii\')">ASCII</button>' : ''}
                            ${payload.binary ? '<button class="payload-tab" onclick="showPayloadTab(event, \'binary\')">Binary</button>' : ''}
                            ${payload.decimal ? '<button class="payload-tab" onclick="showPayloadTab(event, \'decimal\')">Decimal</button>' : ''}
                        </div>
                        ${payload.hex ? `<div class="payload-content hex-data" data-tab="hex">${payload.hex}</div>` : ''}
                        ${payload.ascii ? `<div class="payload-content ascii-data" data-tab="ascii" style="display: none;">${payload.ascii}</div>` : ''}
                        ${payload.binary ? `<div class="payload-content binary-data" data-tab="binary" style="display: none;">${payload.binary}</div>` : ''}
                        ${payload.decimal ? `<div class="payload-content decimal-data" data-tab="decimal" style="display: none;">${payload.decimal}</div>` : ''}
                    </div>
                    ` : '<div class="payload-section"><h4>No Payload Data</h4></div>'}
                </div>
            `;
        }

        function togglePacketDetails(index) {
            const packetEntry = document.getElementById(`packet-${index}`);
            const isExpanded = packetEntry.classList.contains('expanded');
            
            if (isExpanded) {
                packetEntry.classList.remove('expanded');
                expandedPackets.delete(index);
            } else {
                packetEntry.classList.add('expanded');
                expandedPackets.add(index);
            }
            
            const toggle = packetEntry.querySelector('.packet-toggle');
            toggle.textContent = packetEntry.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
        }

        function showPayloadTab(event, tabName) {
            const payloadSection = event.target.closest('.payload-section');
            
            // Update tab buttons
            payloadSection.querySelectorAll('.payload-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide content
            payloadSection.querySelectorAll('.payload-content').forEach(content => {
                content.style.display = content.dataset.tab === tabName ? 'block' : 'none';
            });
        }

        function toggleDetailsView() {
            const showDetails = document.getElementById('showDetails').checked;
            const entries = document.querySelectorAll('.packet-entry');
            
            expandedPackets.clear(); // Clear current state
            
            entries.forEach((entry, index) => {
                if (showDetails) {
                    entry.classList.add('expanded');
                    entry.querySelector('.packet-toggle').textContent = '‚ñ≤';
                    expandedPackets.add(index);
                } else {
                    entry.classList.remove('expanded');
                    entry.querySelector('.packet-toggle').textContent = '‚ñº';
                }
            });
        }

        function updateFilterStats() {
            const stats = document.getElementById('filterStats');
            const total = packetLogs.length;
            const filtered = filteredLogs.length;
            const clientToServer = filteredLogs.filter(log => log.direction === 'CLIENT‚ÜíSERVER').length;
            const serverToClient = filteredLogs.filter(log => log.direction === 'SERVER‚ÜíCLIENT').length;
            
            stats.textContent = `Showing ${filtered} of ${total} packets | ‚Üë ${clientToServer} outbound | ‚Üì ${serverToClient} inbound`;
        }

        function toggleAutoRefresh() {
            const autoRefresh = document.getElementById('autoRefresh').checked;
            const statusEl = document.getElementById('autoRefreshStatus');
            
            if (autoRefresh) {
                statusEl.textContent = '(Auto-refresh: ON)';
                // Use longer interval to be less disruptive (10 seconds instead of 2)
                autoRefreshInterval = setInterval(() => {
                    // Only refresh if no packets have been added recently via real-time updates
                    const lastPacketTime = packetLogs.length > 0 ? new Date(packetLogs[0].timestamp).getTime() : 0;
                    const now = Date.now();
                    
                    // If last packet is older than 5 seconds, do a full refresh
                    if (now - lastPacketTime > 5000) {
                        statusEl.textContent = '(Auto-refresh: ACTIVE)';
                        loadPacketLogs();
                        setTimeout(() => {
                            statusEl.textContent = '(Auto-refresh: ON)';
                        }, 1000);
                    } else {
                        statusEl.textContent = '(Auto-refresh: PAUSED - Live updates active)';
                    }
                }, 10000);
            } else {
                statusEl.textContent = '(Auto-refresh: OFF)';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        function refreshLogs() {
            loadPacketLogs();
        }

        async function exportLogs() {
            try {
                // Export current filtered logs as JSON
                if (filteredLogs.length === 0) {
                    alert('No logs to export');
                    return;
                }

                const exportData = {
                    exportDate: new Date().toISOString(),
                    totalLogs: filteredLogs.length,
                    logs: filteredLogs
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `packet-logs-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                alert(`Exported ${filteredLogs.length} packet logs`);
            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed');
            }
        }

        async function clearLogs() {
            if (!confirm('Are you sure you want to clear the displayed packet logs?')) {
                return;
            }

            try {
                // Clear the client-side logs display
                packetLogs = [];
                filteredLogs = [];
                renderLogs();
                updateFilterStats();
                alert('Displayed logs cleared');
            } catch (error) {
                console.error('Clear failed:', error);
                alert('Clear failed');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            toggleAutoRefresh(); // Start auto-refresh if enabled
        });
    </script>
</body>
</html>
